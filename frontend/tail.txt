              v-if="greetingMessage"
              class="rounded-xl border border-[color:var(--app-shell-border)] px-4 py-3 text-sm font-semibold text-[color:var(--text-base)] dark:text-white"
            >
              {{ greetingMessage }}
            </div>
            <RouterLink
              :to="adminLink"
              class="inline-flex items-center gap-2 rounded-xl border border-[color:var(--app-shell-border)] px-3 py-2 font-medium text-primary-700 transition hover:bg-white/80 dark:text-primary-200"
              @click="closeMobileMenu"
            >
              <ShieldCheckIcon class="h-5 w-5" />
              <span>{{ adminLinkLabel }}</span>
            </RouterLink>
            <RouterLink
              v-if="auth.isAuthenticated && auth.user?.role === 'AdminGeral'"
              to="/admin/system-config"
              class="inline-flex items-center gap-2 rounded-xl border border-[color:var(--app-shell-border)] px-3 py-2 font-medium text-[color:var(--text-base)] transition hover:bg-white/80"
              @click="closeMobileMenu"
            >
              <span>Configurações</span>
            </RouterLink>
            <button
              v-if="auth.isAuthenticated"
              type="button"
              class="inline-flex items-center gap-2 rounded-xl border border-[color:var(--app-shell-border)] px-3 py-2 text-left font-medium text-neutral-700 transition hover:bg-white/80 dark:text-neutral-100"
              @click="handleSignOut"
            >
              <ArrowRightOnRectangleIcon class="h-5 w-5" />
              <span>Sair</span>
            </button>
          </div>
        </transition>
      </header>

      <div
        class="mx-auto flex min-h-[calc(100vh-72px)] w-full max-w-[98%] flex-col rounded-[32px] border border-[color:var(--app-shell-border)] bg-[color:var(--app-shell-bg)] px-4 py-10 shadow-[0_45px_120px_-60px_rgba(15,23,42,0.5)] backdrop-blur 2xl:max-w-[1900px] sm:px-6"
      >
        <main v-if="isAdminLayout" class="flex flex-1 gap-6 pb-6 min-h-[calc(100vh-72px)]">
          <AdminSidebar :is-open="isSidebarOpen" :menu-items="adminMenuItems" @toggle="toggleSidebar" />
          <div class="flex-1 rounded-[28px] bg-[#F5F7FA] p-4 sm:p-6">
            <button
              type="button"
              class="mb-4 inline-flex items-center gap-2 rounded-full border border-[#E4E7EC] bg-white px-4 py-2 text-sm font-medium text-[#1A1A1A] shadow-sm transition hover:-translate-y-0.5 md:hidden"
              @click="toggleSidebar"
            >
              <Bars3Icon class="h-5 w-5" aria-hidden="true" />
              Menu
            </button>
            <RouterView />
          </div>
        </main>
        <main v-else class="flex-1 pb-10">
          <RouterView />
        </main>

        <footer
          class="mt-auto border-t border-[color:var(--app-shell-border)] bg-[color:var(--surface-card-alt)] py-6 text-center text-sm text-[color:var(--text-muted)]"
        >
          &copy; {{ new Date().getFullYear() }} CATRE Ipitinga. Sistema de inscrições e check-in.
        </footer>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, onBeforeUnmount, onMounted, ref, watch } from "vue";
import { RouterLink, RouterView, useRoute, useRouter } from "vue-router";
import { storeToRefs } from "pinia";
import {
  ArrowRightOnRectangleIcon,
  Bars3Icon,
  BanknotesIcon,
  BuildingOffice2Icon,
  CalendarDaysIcon,
  ClipboardDocumentListIcon,
  Cog6ToothIcon,
  MapPinIcon,
  MoonIcon,
  QrCodeIcon,
  ShieldCheckIcon,
  Squares2X2Icon,
  SunIcon,
  UserPlusIcon,
  UsersIcon,
  XMarkIcon
} from "@heroicons/vue/24/outline";

import { useTheme } from "./composables/useTheme";
import { useAuthStore } from "./stores/auth";
import { useSystemConfigStore } from "./stores/system-config";
import AdminSidebar from "./components/admin/AdminSidebar.vue";

const { isDark, toggleTheme } = useTheme();
const router = useRouter();
const route = useRoute();
const auth = useAuthStore();
const systemConfigStore = useSystemConfigStore();
const { config: systemConfig } = storeToRefs(systemConfigStore);
const mobileMenuOpen = ref(false);
const currentTime = ref(new Date());
const isSidebarOpen = ref(false);
let timer: number | undefined;

const adminMenuItems = [
  { label: "Dashboard", to: { name: "admin-dashboard" }, icon: Squares2X2Icon },
  { label: "Eventos", to: { name: "admin-events" }, icon: CalendarDaysIcon },
  { label: "Distritos", to: { name: "admin-districts" }, icon: MapPinIcon },
  { label: "Igrejas", to: { name: "admin-churches" }, icon: BuildingOffice2Icon },
  { label: "Ministerios", to: { name: "admin-ministries" }, icon: UsersIcon },
  { label: "Usuarios", to: { name: "admin-users" }, icon: UserPlusIcon },
  { label: "Permissoes", to: { name: "admin-profiles" }, icon: ShieldCheckIcon },
  { label: "Pedidos", to: { name: "admin-orders" }, icon: ClipboardDocumentListIcon },
  { label: "Inscricoes", to: { name: "admin-registrations" }, icon: UsersIcon },
  { label: "Financeiro", to: { name: "admin-financial" }, icon: BanknotesIcon },
  { label: "Check-in", to: { name: "admin-checkin" }, icon: QrCodeIcon },
  { label: "Configuracoes", to: "/admin/system-config", icon: Cog6ToothIcon }
];

const isAdminLayout = computed(() => {
  if (!route.path.startsWith("/admin")) {
    return false;
  }
  return route.name !== "admin-login";
});

const toggleSidebar = () => {
  isSidebarOpen.value = !isSidebarOpen.value;
};

watch(
  () => route.fullPath,
  () => {
    if (!isAdminLayout.value) {
      isSidebarOpen.value = false;
      return;
    }
    if (typeof window !== "undefined" && window.innerWidth < 768) {
      isSidebarOpen.value = false;
    }
  }
);

const activeBrandLogo = computed(() => {
  const branding = systemConfig.value.branding;
  if (isDark.value) {
    return branding.logoDarkUrl ?? branding.logoLightUrl ?? "";
  }
  return branding.logoLightUrl ?? branding.logoDarkUrl ?? "";
});

const adminLink = computed(() =>
  auth.isAuthenticated ? { name: "admin-dashboard" } : { name: "admin-login" }
);
const adminLinkLabel = computed(() => (auth.isAuthenticated ? "Painel admin" : "Admin"));
const userDisplayName = computed(() => {
  const name = auth.user?.name?.trim();
  if (!name) return "";
  const parts = name.split(/\s+/).filter(Boolean);
  if (parts.length <= 1) {
    return parts[0] ?? "";
  }
  return `${parts[0]} ${parts[parts.length - 1]}`;
});
const greetingMessage = computed(() => {
  if (!auth.isAuthenticated) return "";
  const displayName = userDisplayName.value;
  if (!displayName) return "";
  const hour = currentTime.value.getHours();
  let greeting = "Ola";
  if (hour >= 5 && hour < 12) {
    greeting = "Bom dia";
  } else if (hour >= 12 && hour < 18) {
    greeting = "Boa tarde";
  } else {
    greeting = "Boa noite";
  }
  return `${greeting}, ${displayName}`;
});

onMounted(() => {
  timer = window.setInterval(() => {
    currentTime.value = new Date();
  }, 60 * 1000);
});

onBeforeUnmount(() => {
  if (timer) {
    window.clearInterval(timer);
  }
});

const handleSignOut = () => {
  auth.signOut();
  router.push({ name: "admin-login" });
  mobileMenuOpen.value = false;
};

const toggleMobileMenu = () => {
  mobileMenuOpen.value = !mobileMenuOpen.value;
};

const closeMobileMenu = () => {
  mobileMenuOpen.value = false;
};
</script>

<style scoped>
.fade-enter-active,
.fade-leave-active {
  transition: opacity 150ms ease;
}
.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
</style>



